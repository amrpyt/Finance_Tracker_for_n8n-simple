# Story 3.2: Expense Logging with AI Extraction

## Status

**Approved**

---

## CRITICAL INSTRUCTIONS FOR DEV AGENT

**TASK TRACKING:**
- ❌ DO NOT create a todo list in Cascade
- ✅ USE the Tasks/Subtasks section in this story file to track progress
- ✅ Check off items as you complete them directly in the markdown

**DEPLOYMENT & TESTING:**
- ✅ After completing ALL tasks, push changes to Convex Cloud: `npx convex deploy`
- ✅ Test the implementation in Convex dashboard to verify everything works
- ✅ Test with real Telegram bot to ensure end-to-end flow works
- ✅ Document any issues or deviations in the Dev Agent Record section

---

## Story

**As a** user,  
**I want** to type "paid 50 for coffee" and have the bot understand and log it,  
**so that** I can track expenses without structured commands.

---

## Acceptance Criteria

1. Convex `transactions` table schema defined with fields: `userId`, `accountId`, `type` (expense/income), `amount`, `description`, `category`, `date`, `createdAt` [`docs/prd/epic-3-transactions.md`](../prd/epic-3-transactions.md)
2. Bot sends user message to Rork API with prompt to extract: amount, description, implied category [`docs/prd/epic-3-transactions.md`](../prd/epic-3-transactions.md)
3. AI response parsed to extract transaction details [`docs/prd/epic-3-transactions.md`](../prd/epic-3-transactions.md)
4. Bot presents extracted details to user for confirmation (e.g., "💸 Expense: 50 EGP for 'coffee' from Main Bank. Confirm?") [`docs/prd/epic-3-transactions.md`](../prd/epic-3-transactions.md)
5. User can confirm (✅), cancel (❌), or edit details by replying [`docs/prd/epic-3-transactions.md`](../prd/epic-3-transactions.md)
6. On confirmation, transaction saved to database and account balance decremented [`docs/prd/epic-3-transactions.md`](../prd/epic-3-transactions.md)
7. Confirmation message includes updated balance (e.g., "✅ Logged! New balance: 2950 EGP") [`docs/prd/epic-3-transactions.md`](../prd/epic-3-transactions.md)

---

## Dev Notes

### Previous Story Insights

- **Story 3.1** successfully implemented the Rork API integration layer with `processUserMessage` action that returns structured AI responses with intent, entities, confidence, and nextAction. [`docs/stories/3.1.rork-toolkit-api-integration.md`](./3.1.rork-toolkit-api-integration.md)
- **AI Infrastructure Ready**: The `convex/ai.ts` module provides `processUserMessage(userId, message, conversationHistory)` which returns `ParsedAIResponse` with intent detection and confidence-based routing. [`docs/stories/3.1.rork-toolkit-api-integration.md`](./3.1.rork-toolkit-api-integration.md)
- **Function Calling Defined**: The `log_expense` function definition already exists in `convex/prompts/functions.ts` with parameters: amount, description, category, accountId, date, confidence, reasoning, clarification_needed. [`docs/stories/3.1.rork-toolkit-api-integration.md`](./3.1.rork-toolkit-api-integration.md)
- **Confidence Thresholds**: High (>85%) = execute after confirmation, Medium (70-85%) = confirm with "Did you mean...?", Low (<70%) = clarify with questions. [`docs/stories/3.1.rork-toolkit-api-integration.md`](./3.1.rork-toolkit-api-integration.md)
- **Bilingual Support**: All error messages and prompts must support Arabic and English based on user's `languagePreference`. [`docs/stories/3.1.rork-toolkit-api-integration.md`](./3.1.rork-toolkit-api-integration.md)
- **Session Management**: Bot server has `SessionManager` (in-memory) for tracking pending confirmations and conversation history. [`docs/stories/2.5.instant-balance-check.md`](./2.5.instant-balance-check.md)

### Data Models

**Transactions Table Schema** (NEW - to be created in this story):

```typescript
transactions: defineTable({
  userId: v.id("users"),              // Reference to users table
  accountId: v.id("accounts"),        // Reference to accounts table
  type: v.union(
    v.literal("expense"),
    v.literal("income")
  ),                                  // Transaction type
  amount: v.number(),                 // Transaction amount (positive number)
  description: v.string(),            // User-provided description
  category: v.string(),               // AI-inferred or user-specified category
  date: v.number(),                   // Transaction date (timestamp)
  isDeleted: v.boolean(),             // Soft delete flag for audit trail
  createdAt: v.number(),              // Record creation timestamp
  updatedAt: v.optional(v.number()),  // Last update timestamp
})
  .index("by_user", ["userId"])
  .index("by_user_not_deleted", ["userId", "isDeleted"])
  .index("by_account", ["accountId"])
  .index("by_user_date", ["userId", "date"])
```

[Source: `convex/schema.ts` - Current schema has users and accounts tables]

**Existing Models to Use**:
- **User Model**: Provides `languagePreference` ("ar" | "en") for bilingual responses. [Source: `convex/schema.ts`]
- **Account Model**: Provides `balance`, `currency`, `isDefault` for transaction processing. [Source: `convex/schema.ts`]

### API Specifications

**New Convex Functions to Create**:

1. **`convex/transactions.ts:createTransaction`** (mutation)
   - **Purpose**: Atomically create transaction and update account balance
   - **Arguments**: `userId`, `accountId`, `type`, `amount`, `description`, `category`, `date`
   - **Returns**: `{ transactionId, newBalance }`
   - **Critical**: Must update transaction AND account balance in same mutation for consistency
   - [Source: `docs/architecture/coding-standards.md` - Balance Consistency rule]

2. **`convex/transactions.ts:getRecentTransactions`** (query) - UPDATE PLACEHOLDER
   - **Purpose**: Fetch recent transactions for AI context
   - **Arguments**: `userId`, `limit` (optional, default 3)
   - **Returns**: Array of transaction objects
   - **Note**: Currently returns empty array (placeholder from Story 3.1)
   - [Source: `convex/transactions.ts` line 20]

**Existing Functions to Use**:
- **`convex/ai.ts:processUserMessage`**: Returns `ParsedAIResponse` with intent="log_expense" and extracted entities
- **`convex/accounts.ts:getUserAccounts`**: Fetch user's accounts to determine default account
- **`convex/users.ts:getUser`**: Fetch user language preference

[Source: Story 3.1 implementation]

### Component Specifications

**Bot Server Components** (to be modified):

1. **`bot/src/handlers/messages.ts`** - Main message handler
   - **Current**: Handles `/start`, `/help`, balance inquiry keywords
   - **Add**: Expense detection and confirmation flow
   - **Flow**:
     1. Detect potential expense message (any non-command text)
     2. Call `convex.action(api.ai.processUserMessage, { userId, message })`
     3. If intent === "log_expense" and nextAction === "execute" or "confirm":
        - Store pending transaction in session
        - Send confirmation message with inline keyboard (✅ Confirm / ❌ Cancel)
     4. If nextAction === "clarify":
        - Send clarification question to user
   - [Source: `docs/architecture/source-tree.md` - Bot handlers structure]

2. **`bot/src/handlers/callbacks.ts`** - Callback query handler
   - **Current**: May not exist yet
   - **Add**: Handle inline keyboard callbacks for transaction confirmation
   - **Callbacks**: `confirm_expense:{sessionId}`, `cancel_expense:{sessionId}`
   - [Source: `docs/architecture/source-tree.md` - Bot handlers structure]

3. **`bot/src/services/session.ts`** - Session manager
   - **Current**: In-memory session storage
   - **Add**: Methods to store/retrieve pending transactions
   - **Structure**: `{ userId: string, pendingTransaction: {...}, expiresAt: number }`
   - [Source: Story 2.5 - SessionManager pattern]

### File Locations

**New Files to Create**:
- **`convex/transactions.ts`**: Full implementation (replace placeholder from Story 3.1)
  - Location: `convex/transactions.ts`
  - Exports: `createTransaction` (mutation), `getRecentTransactions` (query), `deleteTransaction` (mutation)
  - [Source: `docs/architecture/source-tree.md` line 78]

**Files to Modify**:
- **`convex/schema.ts`**: Add `transactions` table definition
  - Location: `convex/schema.ts`
  - [Source: `convex/schema.ts` - Current schema]

- **`bot/src/handlers/messages.ts`**: Add expense detection and confirmation flow
  - Location: `bot/src/handlers/messages.ts`
  - [Source: `docs/architecture/source-tree.md` line 33]

- **`bot/src/handlers/callbacks.ts`**: Create if doesn't exist, add confirmation handlers
  - Location: `bot/src/handlers/callbacks.ts`
  - [Source: `docs/architecture/source-tree.md` line 34]

- **`bot/src/services/session.ts`**: Add pending transaction storage
  - Location: `bot/src/services/session.ts`
  - [Source: `docs/architecture/source-tree.md` line 39]

### Testing Requirements

**Testing Framework**: Vitest for Convex functions, Jest for bot server [Source: `docs/architecture/tech-stack.md`]

**Test Files to Create**:
1. **`convex/tests/transactions.test.ts`** - Unit tests for transaction functions
   - Test `createTransaction`: expense creation, balance decrement, atomic operation
   - Test `getRecentTransactions`: filtering, sorting, limit
   - Test error cases: invalid amount, missing account, negative balance
   - [Source: `docs/architecture/coding-standards.md` - Test Coverage Requirements]

2. **`bot/tests/handlers/messages.test.ts`** - Bot message handler tests
   - Test expense detection from natural language
   - Test confirmation message formatting
   - Test session storage of pending transactions
   - [Source: `docs/architecture/source-tree.md` line 56]

**Coverage Target**: 80%+ for business logic [Source: `docs/architecture/coding-standards.md` line 81]

**Key Test Scenarios**:
- Successful expense extraction and logging (English)
- Successful expense extraction and logging (Arabic)
- Ambiguous input requiring clarification
- User confirmation flow (confirm/cancel)
- Balance update verification
- Soft delete (isDeleted flag, not physical delete)
- Edge case: negative amount (should reject)
- Edge case: missing account (should use default)

### Technical Constraints

**Critical Rules from Coding Standards**:

1. **Balance Consistency**: Transaction creation and balance update MUST happen in same mutation
   ```typescript
   // ✅ CORRECT - Atomic operation
   const transactionId = await ctx.db.insert("transactions", {...});
   await ctx.db.patch(accountId, { balance: newBalance });
   ```
   [Source: `docs/architecture/coding-standards.md` lines 60-95]

2. **Soft Deletes**: Never physically delete transactions, use `isDeleted` flag
   [Source: `docs/architecture/coding-standards.md` lines 98-120]

3. **User Data Isolation**: Every query/mutation MUST filter by `userId`
   [Source: `docs/architecture/coding-standards.md` lines 12-34]

4. **Bilingual Errors**: All user-facing errors in Arabic and English
   [Source: `docs/architecture/coding-standards.md` lines 149-175]

5. **Input Validation**: Validate all inputs before processing
   - Amount must be positive number
   - Description max 200 characters
   - Category from predefined list
   [Source: `docs/architecture/coding-standards.md` lines 177-210]

6. **AI Confirmation Pattern**: Always present AI-extracted data for user confirmation before saving
   [Source: `docs/architecture/coding-standards.md` lines 122-147]

**Performance Considerations**:
- Use database indexes for queries: `by_user`, `by_user_not_deleted`, `by_user_date`
- Avoid N+1 queries when fetching transactions with account details
- [Source: `docs/architecture/coding-standards.md` lines 646-712]

**Security Requirements**:
- Validate user owns the account before creating transaction
- Sanitize description input (max length, remove HTML-like characters)
- Never expose other users' transaction data
- [Source: `docs/architecture/coding-standards.md` lines 590-642]

### Project Structure Notes

**Import Conventions**:
- Convex functions: Use relative imports (e.g., `./lib/errors`, not `@/lib/errors`)
- Bot server: Can use path aliases (e.g., `@/services/convex`)
- [Source: `docs/architecture/source-tree.md` lines 261-289]

**File Naming**:
- Convex files: camelCase (e.g., `transactions.ts`)
- Test files: `*.test.ts` suffix
- [Source: `docs/architecture/source-tree.md` lines 222-258]

**Telegram Bot Patterns**:
- Use inline keyboards for confirmations (not reply keyboards)
- Format currency with locale (e.g., "50 EGP" not "EGP 50")
- Include emojis for visual clarity (💸 expense, 💰 income, ✅ success, ❌ error)
- [Source: Bot implementation patterns from Story 2.5]

---

## Tasks / Subtasks

### Task 1: Define Transactions Table Schema (AC 1)
- [ ] Add `transactions` table to `convex/schema.ts` with all required fields
- [ ] Define indexes: `by_user`, `by_user_not_deleted`, `by_account`, `by_user_date`
- [ ] Add TypeScript interface for Transaction type in `shared/src/types/transaction.ts`
- [ ] Verify schema compiles and Convex generates types

### Task 2: Implement Transaction Convex Functions (AC 1, 6)
- [ ] Replace placeholder `convex/transactions.ts` with full implementation
- [ ] Implement `createTransaction` mutation:
  - Validate inputs (positive amount, valid category, user owns account)
  - Insert transaction record
  - Update account balance atomically in same mutation
  - Return `{ transactionId, newBalance }`
- [ ] Implement `getRecentTransactions` query:
  - Filter by userId and isDeleted=false
  - Sort by date descending
  - Limit to specified count (default 3)
- [ ] Implement `deleteTransaction` mutation (soft delete with isDeleted flag)
- [ ] Add bilingual error messages for validation failures

### Task 3: Extend Bot Message Handler for Expense Detection (AC 2, 3, 4)
- [ ] Modify `bot/src/handlers/messages.ts` to detect expense messages
- [ ] Call `convex.action(api.ai.processUserMessage)` for non-command messages
- [ ] Parse AI response to extract expense details
- [ ] Handle different confidence levels:
  - High (>85%): Present for confirmation
  - Medium (70-85%): Present with "Did you mean...?"
  - Low (<70%): Ask clarifying questions
- [ ] Format confirmation message with inline keyboard (✅ Confirm / ❌ Cancel)
- [ ] Store pending transaction in session with expiration (5 minutes)

### Task 4: Implement Confirmation Flow (AC 5, 6, 7)
- [ ] Create/modify `bot/src/handlers/callbacks.ts` for inline keyboard callbacks
- [ ] Handle `confirm_expense` callback:
  - Retrieve pending transaction from session
  - Call `convex.mutation(api.transactions.createTransaction)`
  - Send success message with updated balance
  - Clear session
- [ ] Handle `cancel_expense` callback:
  - Clear pending transaction from session
  - Send cancellation message
- [ ] Add timeout handling (auto-cancel after 5 minutes)

### Task 5: Enhance Session Manager (AC 5)
- [ ] Add methods to `bot/src/services/session.ts`:
  - `setPendingTransaction(userId, transactionData, expiresAt)`
  - `getPendingTransaction(userId)`
  - `clearPendingTransaction(userId)`
- [ ] Implement automatic cleanup of expired sessions
- [ ] Add session data structure for pending transactions

### Task 6: Bilingual Message Formatting (AC 4, 7)
- [ ] Create message formatters in `bot/src/utils/formatters.ts`:
  - `formatExpenseConfirmation(transaction, account, language)`
  - `formatExpenseSuccess(transaction, newBalance, language)`
  - `formatClarificationQuestion(question, language)`
- [ ] Support Arabic and English based on user's `languagePreference`
- [ ] Include appropriate emojis and formatting

### Task 7: Unit Testing (AC 1-7)
- [ ] Create `convex/tests/transactions.test.ts`:
  - Test `createTransaction` with valid expense
  - Test balance decrement is atomic
  - Test soft delete functionality
  - Test input validation (negative amount, invalid category)
  - Test user isolation (can't create transaction for other user's account)
- [ ] Create `bot/tests/handlers/messages.test.ts`:
  - Test expense detection from natural language
  - Test AI response parsing
  - Test confirmation message generation
  - Test session storage
- [ ] Create `bot/tests/handlers/callbacks.test.ts`:
  - Test confirm callback flow
  - Test cancel callback flow
  - Test expired session handling
- [ ] Achieve 80%+ test coverage

### Task 8: Integration Testing
- [ ] Manual test with real Telegram bot:
  - Send "paid 50 for coffee" (English)
  - Send "دفعت ٣٠ جنيه على قهوة" (Arabic)
  - Test confirmation flow (confirm and cancel)
  - Verify balance updates correctly
  - Test ambiguous input ("I bought something")
- [ ] Verify in Convex dashboard:
  - Transaction records created correctly
  - Account balances updated
  - Soft delete works (isDeleted flag)

---

## Testing

**Unit Tests**: 
- `convex/tests/transactions.test.ts` - Transaction function tests with Vitest
- `bot/tests/handlers/messages.test.ts` - Message handler tests with Jest
- `bot/tests/handlers/callbacks.test.ts` - Callback handler tests with Jest

**Integration Tests**:
- Manual testing with real Telegram bot and Convex backend
- Test scenarios: English messages, Arabic messages, confirmations, cancellations, edge cases

**Coverage Target**: 80%+ for Convex functions and bot handlers

**Key Test Scenarios**:
1. Successful expense logging (English): "paid 50 for coffee"
2. Successful expense logging (Arabic): "دفعت ٣٠ جنيه على قهوة"
3. Ambiguous input requiring clarification: "I bought something"
4. User confirms transaction (✅)
5. User cancels transaction (❌)
6. Balance update verification
7. Soft delete (isDeleted flag)
8. Edge case: negative amount (should reject)
9. Edge case: missing account (should use default)
10. Session expiration (5 minutes)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-03 | 0.1 | Initial draft created | Bob (Scrum Master) |

---

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent during implementation_

---

### Debug Log References

_To be filled by Dev Agent during implementation_

---

### Completion Notes

_To be filled by Dev Agent during implementation_

---

### File List

_To be filled by Dev Agent during implementation_

---

## QA Results

_To be filled by QA Agent after implementation_
