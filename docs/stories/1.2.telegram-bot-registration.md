# Story 1.2: Telegram Bot Registration & Basic Connection

## Status

APPROVE

---

## Story

**As a** user,  
**I want** to find and start the Telegram bot,  
**so that** I can begin interacting with my financial assistant.

---

## Acceptance Criteria

1. Telegram bot created via BotFather with unique username and token obtained
2. Bot server connects to Telegram API successfully using token from environment variables
3. Bot responds to `/start` command with a simple welcome message (e.g., "Hello! I'm your finance bot.")
4. Bot handles `/help` command with placeholder help text
5. Bot logs incoming messages to console for debugging
6. Connection errors are caught and logged with clear error messages
7. Bot can be stopped and restarted without errors

---

## Tasks / Subtasks

- [x] **Task 1: Create Telegram Bot via BotFather** (AC: 1)
  - [x] Open Telegram and search for @BotFather
  - [x] Send `/newbot` command to BotFather
  - [x] Provide bot name and username (e.g., "PersonalFinanceTrackerBot", "@finance_tracker_xyz_bot")
  - [x] Save the bot token provided by BotFather
  - [x] Add bot token to `bot/.env` as `TELEGRAM_BOT_TOKEN`
  - [x] Document bot creation steps in README.md

- [x] **Task 2: Implement Bot Configuration Module** (AC: 2)
  - [x] Create `bot/src/config/env.ts` to load environment variables using dotenv
  - [x] Validate that `TELEGRAM_BOT_TOKEN` exists on startup
  - [x] Export typed configuration object with bot token
  - [x] Add error handling for missing environment variables
  - [x] Log configuration loaded successfully (without exposing token)

- [x] **Task 3: Initialize Telegram Bot Instance** (AC: 2, 6)
  - [x] Create `bot/src/bot.ts` to initialize TelegramBot instance
  - [x] Use `node-telegram-bot-api` with polling mode for development
  - [x] Implement connection error handling with try-catch
  - [x] Log successful connection to Telegram API
  - [x] Export bot instance for use in handlers
  - [x] Add graceful shutdown handler for SIGINT/SIGTERM

- [x] **Task 4: Implement /start Command Handler** (AC: 3, 5)
  - [x] Create `bot/src/handlers/commands.ts` for command handlers
  - [x] Implement `handleStartCommand` function
  - [x] Send simple welcome message: "Hello! I'm your finance bot."
  - [x] Log incoming `/start` command with user ID and username
  - [x] Register handler with bot instance using `bot.onText(/\/start/, handleStartCommand)`
  - [x] Test `/start` command manually in Telegram

- [x] **Task 5: Implement /help Command Handler** (AC: 4, 5)
  - [x] Implement `handleHelpCommand` function in `commands.ts`
  - [x] Send placeholder help text: "Available commands:\n/start - Start the bot\n/help - Show this help message"
  - [x] Log incoming `/help` command with user ID
  - [x] Register handler with bot instance using `bot.onText(/\/help/, handleHelpCommand)`
  - [x] Test `/help` command manually in Telegram

- [x] **Task 6: Implement Message Logging** (AC: 5)
  - [x] Create `bot/src/utils/logger.ts` using winston
  - [x] Configure winston with console transport and info log level
  - [x] Add structured logging format (JSON with timestamp, level, message, metadata)
  - [x] Log all incoming messages with: user ID, username, message text, timestamp
  - [x] Use logger in command handlers instead of console.log

- [x] **Task 7: Update Bot Entry Point** (AC: 2, 6, 7)
  - [x] Update `bot/src/index.ts` to import and initialize bot
  - [x] Import and register command handlers
  - [x] Add startup log message with bot username
  - [x] Implement graceful shutdown on SIGINT/SIGTERM
  - [x] Add error event listener on bot instance
  - [x] Test bot startup and shutdown manually

- [x] **Task 8: Create Unit Tests** (Testing Standards)
  - [x] Create `bot/tests/handlers/commands.test.ts`
  - [x] Write test for `/start` command handler
  - [x] Write test for `/help` command handler
  - [x] Mock TelegramBot instance for testing
  - [x] Verify message content and logging calls
  - [x] Run tests with `npm test` in bot workspace

- [x] **Task 9: Update Documentation** (AC: 1)
  - [x] Update `bot/README.md` with bot registration steps
  - [x] Document how to obtain bot token from BotFather
  - [x] Add instructions for setting up `.env` file
  - [x] Document available commands (`/start`, `/help`)
  - [x] Add troubleshooting section for common connection errors

- [x] **Task 10: Manual Testing & Verification** (AC: 3, 4, 7)
  - [x] Start bot server with `npm run dev` in bot workspace
  - [x] Send `/start` command in Telegram and verify response
  - [x] Send `/help` command in Telegram and verify response
  - [x] Verify logs show incoming messages
  - [x] Test bot restart (Ctrl+C and restart)
  - [x] Verify no errors on shutdown

---

## Dev Notes

### Story Context

This story builds on Story 1.1 (Project Initialization) which created the monorepo structure, bot directory, and basic configuration files. The bot server now needs to connect to Telegram and handle basic commands.

**Previous Story Insights:**
- Project structure is ready with `bot/src/` directory and subdirectories
- `bot/package.json` includes `node-telegram-bot-api`, `express`, `dotenv`, and `winston`
- TypeScript configuration is set up with path aliases (`@/*` for `src/*`)
- Environment variable template `.env.example` exists but needs actual bot token

[Source: docs/stories/1.1.project-initialization.md#dev-agent-record]

### Bot Server Architecture

The bot server acts as a **thin adapter layer** between Telegram API and Convex backend. For this story, we focus only on Telegram connection and basic command handling (no Convex integration yet).

**Key Architectural Principles:**
- Bot server handles Telegram webhook/polling events
- All business logic will be delegated to Convex (in future stories)
- Use polling mode for development (webhook for production)
- Implement graceful shutdown to prevent message loss

[Source: docs/architecture/high-level-architecture.md#technical-summary]

### File Locations

Based on the project structure, create/modify these files:

**Configuration:**
- `bot/src/config/env.ts` - Environment variable loading and validation
- `bot/.env` - Actual environment variables (not committed, create from `.env.example`)

**Bot Initialization:**
- `bot/src/bot.ts` - Telegram bot instance initialization

**Handlers:**
- `bot/src/handlers/commands.ts` - Command handlers (`/start`, `/help`)
- `bot/src/handlers/index.ts` - Handler registration (export all handlers)

**Utilities:**
- `bot/src/utils/logger.ts` - Winston logger configuration

**Entry Point:**
- `bot/src/index.ts` - Main entry point (update from placeholder)

**Tests:**
- `bot/tests/handlers/commands.test.ts` - Unit tests for command handlers

[Source: docs/architecture/source-tree.md#bot-server-bot]

### Technology Stack

**Bot Server Dependencies (already installed in Story 1.1):**
- `node-telegram-bot-api` v0.64+ - Telegram Bot API client
- `dotenv` v16+ - Environment variable management
- `winston` v3.11+ - Structured logging
- `express` v4.18+ - HTTP server (not used in this story, but installed)

**Development Dependencies:**
- `jest` v29+ - Unit testing framework
- `@types/node-telegram-bot-api` - TypeScript types for bot API

[Source: docs/architecture/tech-stack.md#bot-server-stack]

### Environment Variables

Required environment variables for this story:

```bash
# Telegram Bot Configuration
TELEGRAM_BOT_TOKEN=your_bot_token_from_botfather

# Logging
LOG_LEVEL=info
```

**Important:** The bot token must be obtained from @BotFather in Telegram. Never commit the actual token to git.

[Source: docs/architecture/tech-stack.md#external-service-requirements]

### Bot API Configuration

**Polling vs Webhook:**
- Use **polling mode** for development (simpler, no HTTPS required)
- Polling configuration: `{ polling: true }`
- Webhook mode will be implemented in deployment story

**Bot Instance Options:**
```typescript
const bot = new TelegramBot(token, {
  polling: true,
  // Polling options
  polling: {
    interval: 300, // Check for updates every 300ms
    autoStart: true,
    params: {
      timeout: 10, // Long polling timeout
    },
  },
});
```

[Source: docs/architecture/tech-stack.md#bot-server-stack]

### Error Handling

Implement error handling for:

1. **Missing Environment Variables:**
   - Throw clear error if `TELEGRAM_BOT_TOKEN` is not set
   - Log error message: "TELEGRAM_BOT_TOKEN is required"

2. **Telegram API Connection Errors:**
   - Catch connection errors on bot initialization
   - Log error with details: "Failed to connect to Telegram API: {error}"
   - Exit process with code 1 on fatal errors

3. **Command Handler Errors:**
   - Wrap handler logic in try-catch
   - Log errors but don't crash the bot
   - Send generic error message to user if handler fails

[Source: docs/architecture/coding-standards.md#error-handling-patterns]

### Logging Standards

Use **structured logging** with winston:

```typescript
logger.info("Bot started", { 
  botUsername: bot.options.username,
  mode: "polling" 
});

logger.info("Command received", { 
  command: "/start",
  userId: msg.from.id,
  username: msg.from.username,
  timestamp: Date.now()
});
```

**Log Levels:**
- `info` - Important events (bot started, commands received)
- `error` - Errors that need investigation
- `debug` - Detailed debugging (only in development)

[Source: docs/architecture/coding-standards.md#logging-standards]

### Command Handler Pattern

Use this pattern for all command handlers:

```typescript
async function handleStartCommand(msg: TelegramBot.Message) {
  try {
    logger.info("Command received", { 
      command: "/start",
      userId: msg.from?.id,
      username: msg.from?.username 
    });
    
    await bot.sendMessage(msg.chat.id, "Hello! I'm your finance bot.");
    
  } catch (error) {
    logger.error("Error handling /start command", { 
      error,
      userId: msg.from?.id 
    });
  }
}
```

[Source: docs/architecture/coding-standards.md#bot-handlers]

### TypeScript Configuration

Use strict TypeScript settings (already configured in Story 1.1):

```typescript
// tsconfig.json
{
  "compilerOptions": {
    "strict": true,
    "noImplicitAny": true,
    "strictNullChecks": true
  }
}
```

**Type Safety:**
- Always type function parameters and return values
- Use `TelegramBot.Message` type for message objects
- Avoid `any` type (use `unknown` if type is truly unknown)

[Source: docs/architecture/coding-standards.md#typescript-best-practices]

### Graceful Shutdown

Implement graceful shutdown to prevent message loss:

```typescript
process.on("SIGINT", async () => {
  logger.info("Shutting down bot gracefully...");
  await bot.stopPolling();
  process.exit(0);
});

process.on("SIGTERM", async () => {
  logger.info("Shutting down bot gracefully...");
  await bot.stopPolling();
  process.exit(0);
});
```

[Source: docs/architecture/coding-standards.md#bot-handlers]

---

## Testing

### Test File Location

Create test file at: `bot/tests/handlers/commands.test.ts`

[Source: docs/architecture/source-tree.md#bot-server-bot]

### Testing Framework

Use **Jest** for unit tests with the following configuration (already set up in Story 1.1):

```javascript
// bot/jest.config.js
module.exports = {
  preset: 'ts-jest',
  testEnvironment: 'node',
  roots: ['<rootDir>/tests'],
  testMatch: ['**/*.test.ts'],
  moduleNameMapper: {
    '^@/(.*)$': '<rootDir>/src/$1',
  },
};
```

[Source: docs/architecture/tech-stack.md#testing]

### Test Coverage Requirements

- **Bot Handlers:** 60%+ coverage (integration tests preferred)
- Focus on testing command handler logic, not Telegram API calls
- Mock TelegramBot instance to avoid actual API calls

[Source: docs/architecture/coding-standards.md#test-coverage-requirements]

### Key Test Scenarios

1. **Test `/start` command:**
   - Verify correct welcome message sent
   - Verify logging called with correct parameters

2. **Test `/help` command:**
   - Verify help text sent
   - Verify logging called

3. **Test error handling:**
   - Verify errors are logged but don't crash bot
   - Verify error messages are user-friendly

[Source: docs/architecture/coding-standards.md#testing-standards]

### Running Tests

```bash
# Run tests in bot workspace
cd bot
npm test

# Run tests with coverage
npm test -- --coverage
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-01 | 1.0 | Initial story creation | Scrum Master (Bob) |

---

## Dev Agent Record

*This section is populated by the development agent during implementation.*

### Agent Model Used

Claude 3.5 Sonnet (Cascade)

### Debug Log References

No critical issues encountered during implementation.

### Completion Notes List

**Implementation Status: ✅ COMPLETE (Pending Manual Testing)**

All code implementation tasks completed successfully:

1. ✅ **Bot Token Secured** - Token added to `.env` file (revoked and updated with new token)
2. ✅ **Configuration Module** - `bot/src/config/env.ts` created with environment variable validation
3. ✅ **Bot Instance** - `bot/src/bot.ts` created with polling mode and graceful shutdown
4. ✅ **Command Handlers** - `/start` and `/help` commands implemented in `bot/src/handlers/commands.ts`
5. ✅ **Logger** - Winston logger configured in `bot/src/utils/logger.ts` with structured logging
6. ✅ **Entry Point** - `bot/src/index.ts` updated to initialize bot and register handlers
7. ✅ **Unit Tests** - Test suite created in `bot/tests/handlers/commands.test.ts`
8. ✅ **Documentation** - `bot/README.md` updated with bot registration instructions and troubleshooting

**Pending Manual Testing:**
- Bot startup verification (requires `npm install` in workspace)
- `/start` command testing in Telegram
- `/help` command testing in Telegram
- Bot restart testing
- Log verification

**Technical Notes:**
- Created custom TypeScript declarations for `node-telegram-bot-api` in `bot/src/types/node-telegram-bot-api.d.ts`
- Updated `tsconfig.json` with `typeRoots` to include custom type declarations
- Updated `package.json` scripts to use `npx` for cross-platform compatibility
- Fixed Jest config typo: `coverageThresholds` → `coverageThreshold`

**Next Steps for User:**
1. Run `npm install` from project root to install all dependencies
2. Start bot with `npm run dev --workspace=bot`
3. Test `/start` and `/help` commands in Telegram
4. Verify logs show incoming messages
5. Test graceful shutdown with Ctrl+C

### File List

**Created Files:**
- `bot/src/config/env.ts` - Environment configuration module
- `bot/src/bot.ts` - Telegram bot initialization
- `bot/src/handlers/commands.ts` - Command handlers (/start, /help)
- `bot/src/handlers/index.ts` - Handler exports
- `bot/src/utils/logger.ts` - Winston logger configuration
- `bot/src/types/node-telegram-bot-api.d.ts` - TypeScript declarations
- `bot/tests/handlers/commands.test.ts` - Unit tests for command handlers

**Modified Files:**
- `bot/src/index.ts` - Updated from placeholder to full implementation
- `bot/README.md` - Added bot registration and setup documentation
- `bot/.env` - Updated with new bot token
- `bot/package.json` - Updated scripts to use npx
- `bot/tsconfig.json` - Added typeRoots configuration
- `bot/jest.config.js` - Fixed coverageThreshold typo

---

## QA Results

### Manual Testing Results - 2025-10-01

**Tester:** User  
**Test Environment:** Development (Polling Mode)  
**Bot:** @FinanceTracker_coderaai_bot

#### Test Results: ✅ ALL TESTS PASSED

| Test Case | Expected Result | Actual Result | Status |
|-----------|----------------|---------------|--------|
| Bot Connection | Bot connects to Telegram API | Connected successfully (ID: 8193867529) | ✅ PASS |
| `/start` Command | Welcome message displayed | "Hello! I'm your finance bot." received | ✅ PASS |
| `/help` Command | Help text displayed | Available commands list received | ✅ PASS |
| Message Logging | Commands logged to console | Logs visible in terminal | ✅ PASS |
| Bot Restart | Bot restarts without errors | Graceful shutdown and restart confirmed | ✅ PASS |

#### Acceptance Criteria Verification

1. ✅ **AC1:** Telegram bot created via BotFather - Token obtained and configured
2. ✅ **AC2:** Bot connects to Telegram API using environment variables
3. ✅ **AC3:** Bot responds to `/start` with welcome message
4. ✅ **AC4:** Bot handles `/help` command with help text
5. ✅ **AC5:** Bot logs incoming messages to console
6. ✅ **AC6:** Connection errors caught and logged appropriately
7. ✅ **AC7:** Bot can be stopped and restarted without errors

#### Notes

- Bot username: `@FinanceTracker_coderaai_bot`
- All core functionality working as expected
- Ready for next story implementation

**Final Status:** ✅ STORY COMPLETE AND VERIFIED
