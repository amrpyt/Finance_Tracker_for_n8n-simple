# Accounts API Documentation

**Version:** 1.0  
**Last Updated:** 2025-10-02

This document describes the Convex API functions for account management.

---

## Table of Contents

- [Mutations](#mutations)
  - [createAccount](#createaccount)
- [Queries](#queries)
  - [getUserAccounts](#getuseraccounts)
- [Data Models](#data-models)
- [Error Codes](#error-codes)

---

## Mutations

### createAccount

Creates a new account for a user.

**Function:** `api.accounts.createAccount`

**Arguments:**

```typescript
{
  userId: Id<"users">,           // Convex user ID
  name: string,                   // Account name (1-50 characters)
  type: "bank" | "cash" | "credit", // Account type
  initialBalance: number          // Starting balance
}
```

**Returns:**

```typescript
{
  accountId: Id<"accounts">,     // Unique account identifier
  name: string,                   // Sanitized account name
  type: "bank" | "cash" | "credit",
  balance: number,                // Initial balance
  currency: string                // Currency code (default: "EGP")
}
```

**Validation Rules:**

- **name**: Must be 1-50 characters after trimming
- **type**: Must be exactly "bank", "cash", or "credit"
- **initialBalance**: 
  - Cannot be negative for "bank" or "cash" accounts
  - Can be negative for "credit" accounts (represents debt)

**Error Codes:**

- `INVALID_NAME` - Account name is empty or exceeds 50 characters
- `INVALID_BALANCE` - Negative balance provided for bank/cash account
- `INVALID_TYPE` - Account type is not one of the allowed values
- `INTERNAL_ERROR` - Unexpected server error

**Example Usage:**

```typescript
// Create a bank account
const account = await convex.mutation(api.accounts.createAccount, {
  userId: "j97...",
  name: "Main Bank Account",
  type: "bank",
  initialBalance: 5000
});

// Create a credit card with debt
const creditCard = await convex.mutation(api.accounts.createAccount, {
  userId: "j97...",
  name: "Visa Card",
  type: "credit",
  initialBalance: -1500  // $1500 in debt
});
```

**Notes:**

- Account names are automatically sanitized (trimmed, HTML characters removed)
- Currency is hardcoded to "EGP" for MVP
- All accounts are linked to the user via `userId`

---

## Queries

### getUserAccounts

Retrieves all accounts for a specific user.

**Function:** `api.accounts.getUserAccounts`

**Arguments:**

```typescript
{
  userId: Id<"users">  // Convex user ID
}
```

**Returns:**

```typescript
Array<{
  _id: Id<"accounts">,
  _creationTime: number,
  userId: Id<"users">,
  name: string,
  type: "bank" | "cash" | "credit",
  balance: number,
  currency: string,
  createdAt: number
}>
```

**Example Usage:**

```typescript
const accounts = await convex.query(api.accounts.getUserAccounts, {
  userId: "j97..."
});

console.log(`User has ${accounts.length} accounts`);
```

**Notes:**

- Results are automatically filtered by `userId` using the `by_user` index
- Accounts are returned in creation order (oldest first)

---

## Data Models

### Account Schema

```typescript
{
  _id: Id<"accounts">,           // Auto-generated by Convex
  _creationTime: number,         // Auto-generated timestamp
  userId: Id<"users">,           // Reference to users table
  name: string,                   // Account name (1-50 chars)
  type: "bank" | "cash" | "credit", // Account type
  balance: number,                // Current balance
  currency: string,               // Currency code (e.g., "EGP")
  createdAt: number               // Manual timestamp
}
```

**Indexes:**

- `by_user` on `["userId", "_creationTime"]` - For fast user-specific queries

---

## Error Codes

All errors follow the `AppError` pattern with bilingual messages:

```typescript
{
  code: string,
  userMessage: {
    en: string,
    ar: string
  }
}
```

### Error Code Reference

| Code | English Message | Arabic Message | When Thrown |
|------|----------------|----------------|-------------|
| `INVALID_NAME` | Account name must be between 1 and 50 characters | يجب أن يكون اسم الحساب بين 1 و 50 حرفاً | Name validation fails |
| `INVALID_BALANCE` | Initial balance cannot be negative for bank or cash accounts | لا يمكن أن يكون الرصيد الأولي سالباً لحسابات البنك أو النقد | Negative balance for bank/cash |
| `INVALID_TYPE` | Account type must be 'bank', 'cash', or 'credit' | يجب أن يكون نوع الحساب 'بنك' أو 'نقد' أو 'ائتمان' | Invalid account type |
| `INTERNAL_ERROR` | An unexpected error occurred. Please try again. | حدث خطأ غير متوقع. يرجى المحاولة مرة أخرى. | Unexpected server error |

---

## Best Practices

### Security

- Always pass the authenticated user's `userId` to prevent unauthorized access
- Never expose other users' account data
- Validate all inputs on the server side

### Performance

- Use the `by_user` index for all user-specific queries
- Avoid querying all accounts without filtering by user

### Data Integrity

- Account balances should be updated atomically with transactions
- Never manually modify balances without creating corresponding transaction records

---

## Related Documentation

- [Users API](./users-api.md)
- [Transactions API](./transactions-api.md) *(coming soon)*
- [Database Schema](../architecture/README.md#database-schema)

---

**Document Owner:** Development Team  
**Last Reviewed:** 2025-10-02
